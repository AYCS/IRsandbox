[{"id":715197,"title":"IP tables routing connected teamspeak clients","body":"<p>On a hosted ubuntu server VPS I host a teamspeak server. Is there anyway to use IPTables to force a connected client to join a different server by forwarding them to the IP?</p>\n\n<p>For example</p>\n\n<p>Teamspeak Server 1 ---> Teamspeak server 2 (Hosted on a second VPS)</p>\n\n<p>I've already tried using the commands:</p>\n\n<pre><code>iptables -t nat -A PREROUTING -s [IP] -j DNAT --to [IP2]\n</code></pre>\n\n<p>and</p>\n\n<pre><code>iptables -t nat -A POSTROUTING -s [IP] -d [IP2] -j MASQUERADE\n</code></pre>\n","related_questions":[{"id":667458,"title":"Ubuntu Teamspeak 3 issue: Could not connect to display","body":"<p>Helllo, Im trying to install Teamspeak 3 on Ubuntu 12.04. I have installed Ubuntu Desktop and it still says this when I try to start the teamspeak sh file. Does anyone know why this is happening and how I can fix it? Thanks!</p>\n\n<p>./ts3client_runscript.sh QXcbConnection: Could not connect to display\n./ts3client_runscript.sh: line 17: 22256 Aborted\n./ts3client_linux_amd64 $@</p>\n"},{"id":650965,"title":"14.04 LTS / Routing with 2 WAN Lines ... on Dom-0 Xen host drives me nuts","body":"<p>Short note: </p>\n\n<p>Well I think I might have a solution but need to prove it first.</p>\n\n<p>Regarding the NAT on the Hardwarerouters to each WAN-line seem just to do NAT for its own subnet, so I will simply need to have them do NAT on the other subnets as well ...</p>\n\n<p>Will put an answer together when its working.</p>\n\n<p>Thanks.</p>\n\n<hr>\n\n<p>I am setting up a Xen-Hypervisor to replace 3 of my old machines with this one.</p>\n\n<p>Base is a Dell PowerEdge 2950 16GB Ram wich contains two physical NICs Ubuntu server Trusty 14.04 all updates done.</p>\n\n<p>My setup is a bit wierd, but I have 4 networks on my intranet side wich is split up into</p>\n\n<pre><code>192.168.0.0/26 - all routing devices, accesspoints and servers\n192.168.0.64/26 - all office and top prio devices\n192.168.0.128/26 - entertainment stuff and kids\n192.168.0.192/26 - low prio and open dhcp area for guests\n</code></pre>\n\n<p>this was because I need to turn down bandwidth on guests and low prio stuff to have enough reserved to work. All done with tc and iptables. That is still active on the old Internetline wich only has 0,5MBits/s DL and 96kBit/s UL on that we stuck for 13 years now.</p>\n\n<p>Since last week I put a LTE (4G) 50MBit/s DL 10MBit/s UL Line in addition to the old one to speed up daily work. BUT 4G is based on transferpackages of 30GB and can be extended by 30GB for additional costs. Since my old line will stay for at least another 2 years until SIP-Trunking will be avaiable for me I want to use the old unlimited line for all sort of intensive things like updates and big downloads wich do not need to be ready at a set time or ftp backups etc.</p>\n\n<p>so far this is my situation.</p>\n\n<p>Now I want to built up a linux box that will do the following beside some other common stuff like LAMP and Mail etc.</p>\n\n<ul>\n<li><p>keep my 4 networks and keep them managable like they were before to reserve bandwidth for top Prio like before but now for two lines.</p></li>\n<li><p>use a hardware router/gateway for each line that do NAT and Dialup\n(have a wrt54gl for the slow DSL line and a Huawei B593u-12 for the LTE side) preferable these should be on 192.168.1.0/24 but I will explain that later.</p></li>\n</ul>\n\n<p>so my setup looks like this:</p>\n\n<pre><code>LTE (B593u-12)\n192.168.1.20\n                  DELL2950 Dom-0                 Clients\n                  (eth1 192.168.1.5)             (192.168.0.XXX/26)\n                  (Xenbr0:X 192.168.0.XXX/26)\nDSL (WRT54GL)\n192.168.1.21\n</code></pre>\n\n<p>now we need some routing from 192.168.1.0/24 to the different networks 192.168.0.0/26, 192.168.0.64/26, 192.168.0.128/26, 192.168.0.192/26 wich are all sitting on Xenbr0 (192.168.0.5), Xenbr0:1 (192.168.0.105), Xenbr0:2 (192.168.0.175), Xenbr0:3 (192.168.0.205)</p>\n\n<p>I am having a problem to establish static routes to each WAN-Router, that I do not need to NAT on my Linux Box, so right now I put 4 IPs on each WAN-Router to have it accessable in each network.</p>\n\n<p>Kernel ip_forwand is enabled!\nI added full ACCEPT policy on iptables FORWARD, INPUT etc. tables to make sure it will not drop any for the time I am sorting the routing on the iproute2 side. </p>\n\n<p>iptables -nvL</p>\n\n<pre><code>Chain INPUT (policy ACCEPT 5418K packets, 762M bytes)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53\n    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53\n    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67\n    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67\n\nChain FORWARD (policy ACCEPT 1406K packets, 107M bytes)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            PHYSDEV match --physdev-out vif4.0 --physdev-is-bridged\n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            PHYSDEV match --physdev-in vif4.0 --physdev-is-bridged\n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            PHYSDEV match --physdev-out vif3.0 --physdev-is-bridged\n    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            PHYSDEV match --physdev-in vif3.0 --physdev-is-bridged\n    0     0 ACCEPT     all  --  *      virbr0  0.0.0.0/0            192.168.122.0/24     ctstate RELATED,ESTABLISHED\n    0     0 ACCEPT     all  --  virbr0 *       192.168.122.0/24     0.0.0.0/0           \n    0     0 ACCEPT     all  --  virbr0 virbr0  0.0.0.0/0            0.0.0.0/0           \n    0     0 REJECT     all  --  *      virbr0  0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable\n    0     0 REJECT     all  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable\n\nChain OUTPUT (policy ACCEPT 5215K packets, 9072M bytes)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 ACCEPT     udp  --  *      virbr0  0.0.0.0/0            0.0.0.0/0            udp dpt:68\n</code></pre>\n\n<p>Xen did his vif and virbr0 device additions in the tables but thes are not interesting for my problem afaik.</p>\n\n<p>Will enable iptable sets later, and will need a hint on these too if possible.\nIs the kernel able to route between all bridges without any extra config, or did I miss something here?</p>\n\n<p>ip route show table main</p>\n\n<pre><code>default via 192.168.1.20 dev eth1 \n192.168.0.0/26 dev xenbr0  proto kernel  scope link  src 192.168.0.5 \n192.168.0.64/26 dev xenbr0  proto kernel  scope link  src 192.168.0.105 \n192.168.0.128/26 dev xenbr0  proto kernel  scope link  src 192.168.0.175 \n192.168.0.192/26 dev xenbr0  proto kernel  scope link  src 192.168.0.205 \n192.168.1.0/24 dev eth1  proto kernel  scope link  src 192.168.1.5 \n192.168.122.0/24 dev virbr0  proto kernel  scope link  src 192.168.122.1 \n224.0.0.0/4 dev xenbr0  scope link \n</code></pre>\n\n<p>and similar on iproute2 for rule based routing:</p>\n\n<p>ip route show table LTE</p>\n\n<pre><code>default via 192.168.1.20 dev eth1 \n192.168.0.0/26 dev xenbr0  proto kernel  scope link  src 192.168.0.5 \n192.168.0.64/26 dev xenbr0  proto kernel  scope link  src 192.168.0.105 \n192.168.0.128/26 dev xenbr0  proto kernel  scope link  src 192.168.0.175 \n192.168.0.192/26 dev xenbr0  proto kernel  scope link  src 192.168.0.205 \n192.168.1.0/24 dev eth1  proto kernel  scope link  src 192.168.1.5\n</code></pre>\n\n<p>ip route show table DSL</p>\n\n<pre><code>default via 192.168.1.21 dev eth1 \n192.168.0.0/26 dev xenbr0  proto kernel  scope link  src 192.168.0.5 \n192.168.0.64/26 dev xenbr0  proto kernel  scope link  src 192.168.0.105 \n192.168.0.128/26 dev xenbr0  proto kernel  scope link  src 192.168.0.175 \n192.168.0.192/26 dev xenbr0  proto kernel  scope link  src 192.168.0.205 \n192.168.1.0/24 dev eth1  proto kernel  scope link  src 192.168.1.5\n</code></pre>\n\n<p>And as far as I know I need to add static routes back from each WAN-Router to the Linuxbox so that it can find the 192.168.0.0/26 and so on...</p>\n\n<p>That is possible on WRT54GL, thanks to DD-WRT Project and on the LTE one i gained root access and configured a startup script that can do similar things to the box like I am able on DD-WRT.</p>\n\n<p>so I would try this on each device:</p>\n\n<pre><code>route add -net 192.168.0.0 mask 255.255.255.192 gw 192.168.1.5\nroute add -net 192.168.0.64 mask 255.255.255.192 gw 192.168.1.5\nroute add -net 192.168.0.128 mask 255.255.255.192 gw 192.168.1.5\nroute add -net 192.168.0.192 mask 255.255.255.192 gw 192.168.1.5\n</code></pre>\n\n<p>Each client gets the fitting IP of Dom-0 regarding their network to reach Dom-0 as the standart gateway. So this works fine. All SMB and CIFS Shares are accessable in the entire Infrastructure.</p>\n\n<p>now I can do the following:\nping the Dom-0 from each WAN-Routers shell (both eth0 and Xenbr0)\nping each WAN-Router from any device in the other 0.XXX/26 nets.</p>\n\n<p>so obviously the routing itself seem to work.</p>\n\n<p>BUT somehow I can not figure out why I can not connect to the Internet from the clients?! The Linux Box itself is online in this scenario and can access both lines and the NATted internet of each WAN-router.</p>\n\n<p>So here I am now. Have read a million and one page about roting, static routes and all sort.</p>\n\n<p>in the end I want to be able to use IFB on eth1 to shape incoming traffic down to a set amount on each line for different rules like subnet, l7-mark, src and dst ip etc. to choose wich line the service will use and how much bandwith it will get via tc and iptables.</p>\n\n<p>is my bridge setup ok?</p>\n\n<pre><code>bridge name bridge id       STP enabled interfaces\nvirbr0      8000.000000000000   yes     \nxenbr0      8000.001d0904bbb4   yes     eth0\n                                        vif3.0\n                                        vif3.0-emu\n                                        vif4.0\n                                        vif4.0-emu\n</code></pre>\n\n<p>vif3 and vif4 are my Xen Guests (use them for developing on mysql etc.), they can access the whole network including all Shares and can ping each device inside the network. So roughly I think it should be ok. Not sure about that STP Option ...</p>\n\n<p>I am a bit confused right now, since I can not see the problem ... hope some of you folks know it better ;)</p>\n\n<p>greets from Germany ... </p>\n"},{"id":344616,"title":"How to install Teamspeak 3 client on ubuntu 12.04 lts 32 bit?","body":"<p>I have been trying to install Teamspeak using the following file but have been unable to do so. I use Ubuntu 12.04 lts 32-bit.</p>\n\n<p><a href=\"http://files.teamspeak-services.com/releases/3.0.12/TeamSpeak3-Client-linux_x86-3.0.12.run\" rel=\"nofollow\">http://files.teamspeak-services.com/releases/3.0.12/TeamSpeak3-Client-linux_x86-3.0.12.run</a></p>\n\n<p>Kindly help with detailed steps since I have started using Ubuntu only yesterday.</p>\n"},{"id":556201,"title":"Install Teamspeak Client on Ubuntu Server","body":"<p>Today I tried to setting up a Teamspeak client for my Ubuntu Server (14.10). I tried to create a music bot.\nI am already at the point where i have the ts3client_runscript.sh and the other files in one directory. \nBut when I try to start the client it gives me the following error message</p>\n\n<pre><code>QXcbConnection: Could not connect to display\n./ts3client_runscript.sh: line 17: 13068 Aborted (core dumped)            \n./ts3client_linux_amd64 $@\n</code></pre>\n\n<p>What does this mean and what can I do to fix it?\nThank you!</p>\n"},{"id":632931,"title":"Teamspeak Client will not install on Ubuntu 15.04","body":"<p>Can someone please explain how to search for an application within the shell when apt-get doesn't work. I am currently in a situation where I cannot find the package I want, but now I am stuck with what to do.</p>\n\n<pre><code>$ sudo apt-get install teamspeak-client \nReading package lists... Done\nBuilding dependency tree        \nReading state information... Done \nE: Unable to locate package teamspeak-client\n</code></pre>\n\n<p>Can someone also explain how to copy large blocks of shell commands into this editor and make it format properly. I'm not indenting every line of commands by 4 spaces every time.</p>\n"},{"id":637188,"title":"iptable rules works sometimes only","body":"<p>I have blocked an attacker IP that was sending me lots of UDP packets.</p>\n\n<p>iptables -I INPUT 1 -s IP_OF_ATTACKER -j DROP</p>\n\n<p>This rule was working all fine.</p>\n\n<pre><code>iptables -nvL --line-numbers\n</code></pre>\n\n<p>22G traffic was blocked for 2-3 days:</p>\n\n<pre><code>num   pkts bytes target     prot opt in     out     source               destination\n1    3203K   22G DROP       all  --  *      *       ATTACKER_IP          0.0.0.0/0\n</code></pre>\n\n<p>However, from last 2-3 days, this rule isn't working anymore. Attacker is sending UDP packets and iptables are not blocking them.</p>\n\n<pre><code>num   pkts bytes target     prot opt in     out     source               destination\n1     707K 3553M DROP       all  --  *      *       ATTACKER_IP         0.0.0.0/0\n</code></pre>\n\n<p>What could be the reason?</p>\n\n<p>PS: Please do not suggest about contacting hosting provider if they were any help I wouldn't be here :)</p>\n\n<h2>Edit</h2>\n\n<p>I used wireshark/tcpdump to analyze/capture packets. It shows all packets are UDP. I use iptables command (as mentioned above) to see how much data iptables rule has blocked. Above is the output of iptables blocked data. When iptable was blocking all the data, our server was working all fine.</p>\n\n<pre><code>**IP Table rules**\n# Generated by iptables-save v1.4.21 on Mon Jun 15 23:26:40 2015\n*raw\n:PREROUTING ACCEPT [8393:667810]\n:OUTPUT ACCEPT [7043:795032]\nCOMMIT\n# Completed on Mon Jun 15 23:26:40 2015\n# Generated by iptables-save v1.4.21 on Mon Jun 15 23:26:40 2015\n*nat\n:PREROUTING ACCEPT [2517:112725]\n:INPUT ACCEPT [2517:112725]\n:OUTPUT ACCEPT [1018:179752]\n:POSTROUTING ACCEPT [1018:179752]\nCOMMIT\n# Completed on Mon Jun 15 23:26:40 2015\n# Generated by iptables-save v1.4.21 on Mon Jun 15 23:26:40 2015\n*mangle\n:PREROUTING ACCEPT [8393:667810]\n:INPUT ACCEPT [8393:667810]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [7043:795032]\n:POSTROUTING ACCEPT [7043:795032]\nCOMMIT\n# Completed on Mon Jun 15 23:26:40 2015\n# Generated by iptables-save v1.4.21 on Mon Jun 15 23:26:40 2015\n*filter\n:INPUT ACCEPT [23:1500]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [18:2068]\n:fail2ban-ssh - [0:0]\n-A INPUT -s xx.xxx.xx.xx/32 -j DROP\nCOMMIT\n# Completed on Mon Jun 15 23:26:40 2015\n</code></pre>\n"},{"id":614834,"title":"How to use my ubuntu server as router?","body":"<pre><code>                       +---+        \n            eth1- *.1.6| S |           \n              =========|   |           \n                       |PC1|private net      --------------------\n                       |   |==============|||PC 2 with eth0 *.0.7|||\n                       | R |eth0-*.0.6       --------------------\n                       +---+\n</code></pre>\n\n<p>eth1 = interface with internet\neth0 = interface private</p>\n\n<p>eth1 and eth0 are two different network</p>\n\n<p>I'd like to share my internet connection to my PC2. I guess it should work with some Iptables rules but doesn't work for me or I don't konw how to do it ...</p>\n\n<p>here is my iptables on PC1:</p>\n\n<hr>\n\n<pre><code>Chain PREROUTING (policy ACCEPT 6 packets, 789 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n\nChain INPUT (policy ACCEPT 6 packets, 789 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 3 packets, 218 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n\nChain POSTROUTING (policy ACCEPT 1 packets, 60 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n       2      158 MASQUERADE  all  --  *      eth0    0.0.0.0/0            0.0.0.0/0\n\n\n\nChain INPUT (policy ACCEPT 2796 packets, 273921 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 3217 packets, 335744 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n</code></pre>\n\n<hr>\n\n<p>I used this command ( sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE ) on my PC1</p>\n\n<p>I tried lot of tutorial but PC2 can't get access to internet !</p>\n\n<p>What can I do ? I'm completly stuck </p>\n"},{"id":575681,"title":"Configuring NAT with ufw instead iptables","body":"<p>I want to apply this iptables rule:</p>\n\n<pre><code> iptables -t nat -A PREROUTING -d 87.13.180.182 -j DNAT --to-destination 192.168.0.13\n</code></pre>\n\n<p>(87blabla is my public ip and 192blabla is my private ip).</p>\n\n<p>People suggested me to use ufw instead iptables since it's easier to use.</p>\n\n<p>So I:</p>\n\n<p>1) Set <strong>DEFAULT_FORWARD_POLICY=\"ACCEPT\"</strong> on /etc/default/ufw <br>\n2) Set <strong>net.ipv4.ip_forward=1</strong> on  /etc/ufw/sysctl.conf <br>\n3) Created the <strong>NAT table</strong> and added my rule on /etc/ufw/before.rules <br></p>\n\n<p>//Nat table <br>\n*nat <br>\n:POSTROUTING ACCEPT [0:0] <br>\n:PREROUTING ACCEPT [0:0] <br></p>\n\n<p>//Nat rule <br>\nPREROUTING -d 87.13.180.182 -j DNAT --to-destination 192.168.0.13</p>\n\n<p>But it doesen't work when i run ufw disable &amp;&amp; ufw enable (error on that line).</p>\n"},{"id":542510,"title":"IPtables client - server(router) error","body":"<p>I've got a school assessment this week.</p>\n\n<p>Let me explain how my environment is:</p>\n\n<p>1 Router (Have DHCP + giving an ip to the client) Has NAT for Internet \n1 Client (Can only have internet acccess via the router) Has HOST-ONLY </p>\n\n<p>My problem: IPTABLES</p>\n\n<p>I've got a couple of rules that i've found on the internet. But none of all are working.\nExample: <a href=\"http://pastebin.com/uKH2rHue\" rel=\"nofollow\">http://pastebin.com/uKH2rHue</a></p>\n\n<p>Is this even possible? because it did not work at mine. </p>\n\n<p>MY question: How can I configure IPTABLES router for redirecting or forwarding the incoming traffic to INTERNET? (HTTP REQUEST by having internet ACCESS)</p>\n\n<p>Thanks in advance!</p>\n"},{"id":362735,"title":"Multipath routing with only one interface","body":"<p>I have two links that connect to Internet in my office network. One of the routers has ip <strong>172.16.0.1</strong> and the other has <strong>172.16.0.3</strong>. They connect to Internet using ppoe so they get an ip each time they connect. </p>\n\n<p>I configured incomming traffic in a way that every that comes from the external IP will be routed to <strong>172.16.0.120</strong>. In 172.16.0.120 there is a webserver so I have load balancing and link failover. </p>\n\n<p>The problem is that it seems I'm unable to tell <strong>172.16.0.120</strong> to route packets from the gateway they come from. And it seems that if I try one link or the other there is only one active (not really active, the packet are always sent through the same router). It depend on the route I add last. </p>\n\n<p>What I do is something like this:</p>\n\n<pre><code>ip rule add from 172.16.0.1 table 1\nip rule add from 172.16.0.3 table 2\nip route add 172.16.0.0/24 dev eth1 scope link table 1\nip route add 172.16.0.0/24 dev eth1 scope link table 2\nip route add default via 172.16.0.1 dev eth1 table 1\nip route add default via 172.16.0.3 dev eth1 table 2\nip route add default scope global nexthop via 172.16.0.1 dev eth1 weight 1 nexthop via 172.16.0.3 dev eth1 weight 1\n</code></pre>\n\n<p>With this is supposed to send packets where they come from. But it's not working. </p>\n\n<p>Maybe some iptables magic is needed here. </p>\n"}]}]