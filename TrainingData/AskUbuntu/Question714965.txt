[{"id":714965,"title":"Why are NAT&amp;Kernel IP Forwarding not working?","body":"<p>I'm trying to forward all traffic from tun0 to eth0,below is my interfaces:</p>\n\n<pre><code> eth0      Link encap:Ethernet  HWaddr 12:57:6e:6a:74:85\n      inet addr:172.31.32.133  Bcast:172.31.47.255  Mask:255.255.240.0\n\ntun0      Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-\n      inet addr:192.168.77.1  P-t-P:192.168.77.2  Mask:255.255.255.255\n</code></pre>\n\n<p>The commands I used are:</p>\n\n<pre><code>sudo bash -c 'echo 1 &gt; /proc/sys/net/ipv4/ip_forward'\nsudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE\nsudo iptables -A FORWARD -i eth0 -o tun0 -m state --state  RELATED,ESTABLISHED -j ACCEPT\nsudo iptables -A FORWARD -i tun0 -o eth0 -j ACCEPT\n</code></pre>\n\n<p>I tried in two machines, but all failed, can't get any response from ping.</p>\n\n<pre><code>$ ping -I tun0 8.8.8.8\n</code></pre>\n","related_questions":[{"id":671986,"title":"Ubuntu Sever NAT latency high","body":"<p>I am running a Ubuntu server which has two network interface card one is 1000Mb/s and another one is 100Mb/s. I have configure NAT with UFW and Dhcp services enabled on the server. I have noticed client connecting to Internet with this server as a gateway has a very low internet speed less than 1M where I have a dedicated 10M connection with the server. I have tried wget to download some files from the Internet but it shows several hours will take to download 500M files in the server. I have checked the latency and it fluctuates to 500ms - 700ms sometimes it shows 20ms to reach google when I ping from the server. </p>\n\n<p>I wonder which causing the latency high? I can reach the gateway in less than 1ms. </p>\n\n<p>Can anyone please advice.  </p>\n"},{"id":614834,"title":"How to use my ubuntu server as router?","body":"<pre><code>                       +---+        \n            eth1- *.1.6| S |           \n              =========|   |           \n                       |PC1|private net      --------------------\n                       |   |==============|||PC 2 with eth0 *.0.7|||\n                       | R |eth0-*.0.6       --------------------\n                       +---+\n</code></pre>\n\n<p>eth1 = interface with internet\neth0 = interface private</p>\n\n<p>eth1 and eth0 are two different network</p>\n\n<p>I'd like to share my internet connection to my PC2. I guess it should work with some Iptables rules but doesn't work for me or I don't konw how to do it ...</p>\n\n<p>here is my iptables on PC1:</p>\n\n<hr>\n\n<pre><code>Chain PREROUTING (policy ACCEPT 6 packets, 789 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n\nChain INPUT (policy ACCEPT 6 packets, 789 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 3 packets, 218 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n\nChain POSTROUTING (policy ACCEPT 1 packets, 60 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n       2      158 MASQUERADE  all  --  *      eth0    0.0.0.0/0            0.0.0.0/0\n\n\n\nChain INPUT (policy ACCEPT 2796 packets, 273921 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 3217 packets, 335744 bytes)\n    pkts      bytes target     prot opt in     out     source               destination\n</code></pre>\n\n<hr>\n\n<p>I used this command ( sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE ) on my PC1</p>\n\n<p>I tried lot of tutorial but PC2 can't get access to internet !</p>\n\n<p>What can I do ? I'm completly stuck </p>\n"},{"id":587536,"title":"Forwarding interfaces inside a docker container","body":"<p>I have created a docker container executing the following command</p>\n\n<pre><code>docker run -it --net=none --cap-add=NET_ADMIN --name firewall ubuntu /bin/bash\n</code></pre>\n\n<p>after I have attached it two interfaces <code>eth0</code> and <code>eth1</code>. I need to forward traffic from eth1 to eth0. I have installed <code>iptables</code> and applying the following simple rule:</p>\n\n<pre><code>iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT\n</code></pre>\n\n<p>I have checked out that traffic arrive to interface eth1 by listening with tcpdump the interface eth1. Unfortunately I don't know the reason why the traffic is not forwarded to eth0. Any idea? All the flags have been properly set up to 1 on the system</p>\n"},{"id":565032,"title":"Forwarding ports with iptables not working?","body":"<p>I have an ubuntu server (14.04.1) which is asking as a router for my network. It has an internet facing interface, eth0, and a second interface, eth1, for connecting to my 10.0.0.0 network.</p>\n\n<p>I am attempting to forward TCP traffic directed to eth0 (for this example, lets say its IP is 118.94.79.113) to eth1 with an address of 10.0.0.1 for port 27016</p>\n\n<p>I have attempted the following commands in sequence:</p>\n\n<p><code>sudo echo \"1\" &gt; /proc/sys/net/ipv4/ip_forward</code></p>\n\n<p><code>sudo sysctl net.ipv4.ip_forward=1</code></p>\n\n<p><code>sudo iptables -t nat -A PREROUTING -p tcp --dport 27016 -j DNAT --to-destination 10.0.0.104:27016</code></p>\n\n<p><code>sudo iptables -t nat -A POSTROUTING -j MASQUERADE</code></p>\n\n<p>but this doesnt seem to work at all, i cannot connect to 118.94.79.113:27016 to access the application running on 10.0.0.104:27016. Is it to do with it being across two interfaces or what?</p>\n"},{"id":551852,"title":"Why is ip forwarding not working in xubuntu 14?","body":"<p>I upgraded my gateway computer from xubuntu 12 to 14 and the computers on my home network lost their internet connection. I found that the upgrade had uninstalled my old firewall, Firestarter, and replaced it with ufw. My efforts to get this working have had no success but what really bothers me is that even with the firewall disabled the clients (my children's computers) still cannot reach the internet. I have done the recommended edits in /etc/ufw/sysctl.conf and when I run \"sysctl net.ipv4.ip_forward\" I get \"net.ipv4.ip_forward = 1\". The hosts and the gateway can ping each other okay but the hosts cannot ping the internet, eg google or 8.8.8.8. The gateway can access the internet but not the hosts. This has worked fine for years until the upgrade. Why is the ip forwarding not working?</p>\n\n<p>Just in case ufw had some default configuration that was preventing ip forwarding I took the drastic step of uninstalling Gufw and ufw. Still no internet access for the host computers. I found another sysctl.conf in /etc and uncommented the line, net.ipv4.ip_forward=1 then ran sudo sysctl -p /etc/sysctl.conf and got the response, net.ipv4.ip_forward = 1. But it's still not working. The hosts can ping the gateway but they cannot reach the internet.</p>\n\n<p>I am not the geeky type who digs about in man pages for fun, but I've had a go. Here is the output from sudo ufw status verbose (My home network is on 192.168.0.0/24):</p>\n\n<p>Status: active\nLogging: on (low)\nDefault: deny (incoming), allow (outgoing), allow (routed)\nNew profiles: skip</p>\n\n<p>To                         Action      From\n--                         ------      ----\n192.168.0.2                ALLOW IN    192.168.0.0/24\n22                         LIMIT IN    Anywhere\nAnywhere on eth0           ALLOW IN    192.168.0.0/24\n22 (v6)                    LIMIT IN    Anywhere (v6)</p>\n\n<p>Does this look okay?</p>\n\n<p>But even if it is good, the real problem, I think, is that the host computers cannot reach the internet. The gateway computer can. Disabling the firewall makes no difference: the host computers can ping the gateway and ssh to the gateway, but they cannot ping an internet site such as 8.8.8.8.</p>\n\n<p>I set up this home network about 7 years ago on Debian then moved to xubuntu lts. Its been really good and I've never had to touch it. I know a lot has changed since then in the system config files so I could really use some help as I use this network for work and children's homework, not as a hobby.\nFollowing ubuntu's own documentation here, <a href=\"https://help.ubuntu.com/lts/serverguide/firewall.html#other-firewall-tools\" rel=\"nofollow\">https://help.ubuntu.com/lts/serverguide/firewall.html#other-firewall-tools</a>, I tried editing /etc/ufw/before.rules: I added these lines:</p>\n\n<h1>nat Table rules</h1>\n\n<p>*nat\n:POSTROUTING ACCEPT [0:0]</p>\n\n<h1>Forward traffic from eth1 through eth0.</h1>\n\n<p>-A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE</p>\n\n<p>However when I restarted the firewall I got this error message:</p>\n\n<p>Firewall stopped and disabled on system startup\nERROR: problem running ufw-init\nBad argument <code>*filter'\nError occurred at line: 22\nTry</code>iptables-restore -h' or 'iptables-restore --help' for more information.</p>\n\n<p>Problem running '/etc/ufw/before.rules'</p>\n\n<p>(I didn't touch line 22!) I restored the file to its original state and the firewall started up okay. I cannot think of anything else to try. Has anybody got any ideas?</p>\n\n<p>I solved the problem by adding the line \"COMMIT\" after the line \"-A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE\". I thought it was not required because COMMIT appears at the end of the file. But that made it work.</p>\n"},{"id":470234,"title":"Passing ICMP between two interfaces","body":"<p>I'm trying to setup routing between two network interfaces on an Ubuntu machine.  The first interface is the nic, connected to my LAN.  The second interface is a tunnel dev created by OpenVPN. </p>\n\n<p>The goals of this routing configuration are to 1) Run a torrent server application which binds its peer connections to the OpenVPN tunnel interface, and route those through the VPN  2) Leave normal internet packet routing alone for the NIC interface. 3) eventually run a SOCKS5 proxy server which accesses the internet through the VPN, but provides service through the LAN interface. 4) eventually use a secondary IP on this machine which acts as an alternate gateway, for which the LAN's router will route certain destinations.</p>\n\n<p>So far, I have achieved goals 1) and 2) and working on the others.  While the routing works for sockets bound to the VPN interface, the problem is that it seems to not be passing ICMP packets between the interfaces.  This will be a problem, as I will want to test routing with traceroute when I achieve goal 4).</p>\n\n<pre>\n>uname -a\nLinux Grover 3.13.0-24-generic #47-Ubuntu SMP Fri May 2 23:31:42 UTC 2014 i686 i686 i686 GNU/Linux\n\n>ip addr\n1: lo:  mtu 65536 qdisc noqueue state UNKNOWN group default \n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n2: eth0:  mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:25:b3:0b:d3:0f brd ff:ff:ff:ff:ff:ff\n    inet 192.168.1.2/24 brd 192.168.1.255 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet 192.168.1.10/24 brd 192.168.1.255 scope global secondary eth0:1\n       valid_lft forever preferred_lft forever\n    inet6 fe80::225:b3ff:fe0b:d30f/64 scope link \n       valid_lft forever preferred_lft forever\n11: tunPIA1:  mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 100\n    link/none \n    inet 10.192.1.6 peer 10.192.1.5/32 scope global tunPIA1\n       valid_lft forever preferred_lft forever\n</pre> \n\n<p>When the manual routing is done for the VPN tunnel, this is what the relevant routing looks like:</p>\n\n<pre>\n>ip route show dev eth0\ndefault via 192.168.1.1 \n169.254.0.0/16  scope link  metric 1000 \n192.168.1.0/24  proto kernel  scope link  src 192.168.1.2 \n192.168.2.0/24 via 192.168.1.1 \n192.168.3.0/24 via 192.168.1.1 \n192.168.4.0/24 via 192.168.1.1 \n192.168.100.0/24 via 192.168.1.1 \n\n>ip rule show\n0:  from all lookup local \n32765:  from 10.192.1.6 lookup rt.tunPIA1 \n32766:  from all lookup main \n32767:  from all lookup default\n\n>ip route show table rt.tunPIA1\ndefault via 10.192.1.5 dev tunPIA1 \n10.192.1.1 via 10.192.1.5 dev tunPIA1 \nthrow 192.168.1.0/24\n</pre>\n\n<p>(The above table will eventually contain other throws for public inet addresses which will not be routed through the VPN.)</p>\n\n<p>Finally, the layer 3 bridging between the interfaces is done with:</p>\n\n<pre>\n>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE\n>iptables -t nat -A POSTROUTING -o tunPIA1 -j MASQUERADE\n>iptables -A FORWARD -i tunPIA1 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT\n>iptables -A FORWARD -i eth0 -o tunPIA1 -m state --state RELATED,ESTABLISHED -j ACCEPT\n</pre>\n\n<p>After this is done,</p>\n\n<pre>\n>wget -O- http://whatismyip.org --bind-address 10.192.1.6\n</pre>\n\n<p>Gives the expected result, and I am similarly able to access http services inside my local lan when bound to the tunPIA1 interface IP address.</p>\n\n<p>However, while</p>\n\n<pre> \n>ping 8.8.8.8 -I tunPIA1\n</pre>\n\n<p>works, the following does not:</p>\n\n<pre>\n>ping 192.168.1.1 -I tunPIA1\n</pre>\n\n<p>tcpdump will show the ICMP packets on the tunPIA1 interface, but not on the eth0 interface.</p>\n\n<p>So my question is: why are ICMP packets not being passed from the tunnel interface to the NIC interface?   </p>\n"},{"id":445685,"title":"Ubuntu forward ports, default state, forwarding not working?","body":"<p>im running ubuntu 12.04.4 server. I been googling the nett for answers, but could not find any..\nI would like accsess a few web-gui's on my server.\nI have forwarder the ports in my router, worked when i runned the same programs on a windows server, but when i went over to linux, all stopt working when im not on LAN.</p>\n\n<p>I have not configured Iptables at all.. As far as i know Iptables is accepting all requests by default?</p>\n\n<p>Anyway, if i need to configuer iptables this is the port.\nLooks like on lan: htps://server-lan-ip:9090 and i would reache the web-gui.\nWhen i used windows server is could simply reache the web-gui form exsternal locations on: \"htps://my-exsternal-ip:9090\" (yes i know its two tt*)</p>\n\n<p>I have tried diffrent iptables rules the i tought would work, but no luck for exsternal location :(</p>\n\n<p>Any suggestions to what i should do?\nI have runned iptables -L -n there are no rules in motion.</p>\n\n<p>thx</p>\n"},{"id":432354,"title":"How do I use NAT in iptables","body":"<p>I have a domain set for my server, let's say <code>example.com</code> which is being forwarded by my router and is linked to my external IP <code>11.111.111.111</code> and it works fine if I ping the domain, or I do a lookup, it recognizes it and gives me the external IP of the domain. But when I listen in on any of the ports I have set to allow, it says they are closed. What rule should I set for this to forward correctly through to my router?</p>\n\n<p>eth0 is my static internal interface and lo it my loop back.</p>\n\n<p>Gateway: 192.168.0.1</p>\n\n<pre><code>ifconfig:\neth0      Link encap:Ethernet  HWaddr 00:0e:7f:a9:10:54  \n          inet addr:192.168.0.8  Bcast:192.168.0.255  Mask:255.255.255.0\n          inet6 addr: fe80::20e:7fff:fea9:1054/64 Scope:Link\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:8175 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:5730 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1000 \n          RX bytes:6186702 (6.1 MB)  TX bytes:1444662 (1.4 MB)\n          Interrupt:20 \n\nlo        Link encap:Local Loopback  \n          inet addr:127.0.0.1  Mask:255.0.0.0\n          inet6 addr: ::1/128 Scope:Host\n          UP LOOPBACK RUNNING  MTU:65536  Metric:1\n          RX packets:0 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0 \n          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)\n</code></pre>\n"},{"id":348806,"title":"NAT forwarding not working","body":"<p>I tried to set up forwarding from <code>eth0</code> to <code>wlan0</code> in ubuntu:</p>\n\n<pre><code>echo 1 &gt; /proc/sys/net/ipv4/ip_forward\niptables -t nat -F\niptables -F\niptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE\niptables -A FORWARD -i wlan0 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT\niptables -A FORWARD -i eth0 -o wlan0 -j ACCEPT\n</code></pre>\n\n<p>But it doesn't work. Pinging 10.0.0.1 (which is the default gateway on <code>wlan0</code> but not <code>eth0</code>) works on <code>wlan0</code> but not on <code>eth0</code>. When running <code>ping -Ieth0 10.0.0.1</code>, there is no output from <code>ping</code>, <code>tcpdump -i wlan0</code> shows nothing, and <code>tcpdump -i eth0</code> shows dropped ICMP packets.</p>\n"},{"id":274210,"title":"Forward [open] Ports 7777; 2106","body":"<p>Hi i am new to Ubuntu (12.10) x64\nTrying to forward ports for gameserver on my pc (Lineage II)\nPorts are opened in UFW \nPorts are opened in my Router\nEven if i disable UFW others still cant login to gameserver \nTried most [Terminal] commands to forward ports still wont open\nI have the server opened which should make ports liste and they should appear to be open in sites like canyouseeme.ogr </p>\n\n<p>Also tried some commands to open them in 'iptables' \nim so confused help </p>\n"}]}]