[{"id":715391,"title":"LVM restore wrong meta file?","body":"<ol>\n<li><p>I added the wrong file instead-of original file. </p>\n\n<pre><code>vgcfgrestore -f /tmp/vg00.backup /dev/rdsk/c0t4d0\n</code></pre></li>\n<li><p>But i did </p>\n\n<pre><code>vgcfgrestore -f /tmp/vg01.backup /dev/rdsk/c0t4d0\n</code></pre></li>\n</ol>\n\n<p>Now my volume shows  volumes in your group. </p>\n\n<p>Any possible to recover my data. \nI am relaying panic, How to restore the original file.</p>\n","related_questions":[{"id":704679,"title":"Kubuntu not logging in after restoring an rscyn-based backup","body":"<p>My setup is as follows:</p>\n\n<p>In an extended partition, there is a 1GB ext2 boot partition, and a LUKS crypto container. Within the container there is an LVM physical volume, with one volume group, within which are 3 logical volumes: lvRoot (12GB), lvHome (20GB) and lvSwap (20GB). On lvRoot there is Kubuntu 15.04 installed, using lvSwap as swap and lvHome as /home. I keep all of my stuff in a completely separate place, so /home is just for application data.</p>\n\n<p>I do regular backups using BackInTime, which is a GUI for automated rsync backups. I back-up the boot partition and lvHome as they are, and lvRoot through an LVM snapshot. That is, I create a snapshot, mount it, back it up, unmount it, and delete it.</p>\n\n<p>A few days ago I had an incident with .xsession-errors growing large and my whole lvHome got filled up and things started braking (this is apparently a known issue). I deleted the file and the system refused to log in (it just froze with the progress bar), so I booted from a live USB stick (also Kubuntu 15.04) and using BackInTime restored lvRoot and lvHome from a backup done in the times when my system was working fine.</p>\n\n<p>After I did that, I still can't log in, but it looks different now: after I type in the password to my account ans hit enter, it seems to start the greeter anew - there is a short moment where the screen is black and in the left corner it displays \"Starting version 219\", just like it does before the login screen first appears. Also the moment I click \"Log In\" after typing in the password, the cursor turns into a black cross, and I don't recall this happening when it logged in normally (I could be wrong though)</p>\n\n<p>I assumed that maybe the system in my last backup was already borked somehow so I restored the very oldest backup that I have - one done right after installing Kubuntu. The behavior was exactly the same after that.</p>\n\n<p>Furthermore, I noticed that if I reboot from the live USB stick again after doing the restore, and mount lvHome, it appears empty. lvRoot is fine, all the files are there, but lvHome is always empty. So I assumed that maybe the logical volume lvHome itself got corrupted somehow by the .xsession-errors filling up all the space, and I was copying files to a corrupted LV, and that's why it didn't work. So I deleted lvHome, created it anew, and restored once again. The files are showing up now, but the system still refuses to log in, the same way as before. I ran fsck on lvHome and lvRoot and it says that they're clear.</p>\n\n<p>I have no idea what's going on here anymore.</p>\n\n<p>I was under the impression (from reading stuff like eg. <a href=\"https://wiki.archlinux.org/index.php/Full_system_backup_with_rsync\" rel=\"nofollow\">this</a>), that backing up using rscync is the right way to do it, and BackInTime also has a good reputation. Furthermore, I tested this backup scheme in a virtual machine (also running Kubuntu 15.04), before I deployed it, and it worked perfectly fine.</p>\n\n<p>Why is it not working now? </p>\n\n<p>I did not restore /boot because I assumed it should be okay, and the system indeed boots up. Was that the mistake? Was it using LVM snapshots? Multiple sources said that the snapshots are a good idea.  </p>\n\n<p>What am I missing here? How do I even diagnose this?</p>\n\n<p>I could just reinstall Kubuntu, but my backup scheme exists for the very reason of me not having to do reinstalls every time something breaks and I want to know why that scheme doesn't work and possibly how can I make it work.</p>\n\n<p>Any thoughts?</p>\n"},{"id":687880,"title":"Fail to mount LVM disks after VPS restore from a backup","body":"<p>After backup restore OS failed to boot. </p>\n\n<p>Recovery mode says LVM drive not found:</p>\n\n<blockquote>\n  <p>dracut Warning: LVM vg_happy/lv_root not found</p>\n  \n  <p>Boot has failed. To debug this issue add \"rdshell\"..</p>\n</blockquote>\n\n<p>Adding <code>rshell</code> command to kernel shows fail on mounting LVM disks because target device is too small:</p>\n\n<blockquote>\n  <p>vda: p2 size 51402752 exceeds device capacity, limited to end of disk</p>\n  \n  <p>dracut: Scanning device vda2 for LVM logical volumes</p>\n  \n  <p>device-mapper: table: 253:0: vda2 too small for target: start: 2048, len= 47267840, dev_size=51552</p>\n  \n  <p>dracut: device-mapper: resume ioctl on failed: Invalid argument.</p>\n</blockquote>\n\n<p>Please advice how to increase size of a VDA so it fits logical volumes.</p>\n\n<p>Thanks!</p>\n"},{"id":424225,"title":"Setting up LVM Snapshot as a backup/restore point in ubuntu","body":"<p>since I could not find how to post this as a blog/post/tutorial in AskUbuntu.. I decided on posting it here, were it is best exposed anyhow ...</p>\n\n<h2><strong>Setting up LVM Snapshot as a backup/restore point in ubuntu.</strong></h2>\n\n<h3><strong>Why?</strong></h3>\n\n<p>Well, as I see it, with all the great usefulness of Linux, its biggest drawback is with its mixed up way of installing apps. All the dlls go to one directory. All the configuration files to another. And the binaries are also put in a bunch. Yes, Windows works the same way more or less, but with the nature of system/server software installed on Linux, being that most of the software installed is only about 95% mature at any given time, messing up your system twice a month is very probable.. </p>\n\n<p>Of course, we can backup the system before and after each installation, but that takes a million years. System backups (as oppose to just data/files backup) requires you to turn off you computer and use some form of bootable live CD and a backup media. And, if the drive is more than 15% full, it might take a long time to do the backup, even with modern hardware.</p>\n\n<p>So, how can this be done?</p>\n"},{"id":680717,"title":"Setting up LVM Snapshot as a backup/restore point in ubuntu on an external drive","body":"<p><a href=\"http://askubuntu.com/questions/424225/setting-up-lvm-snapshot-as-a-backup-restore-point-in-ubuntu\">Here</a> is a good article on how to use LVM Snapshot as backup/restore. But the thing is I would like to have that backup saved on my external hard drive.</p>\n\n<p>This was my approach:</p>\n\n<ol>\n<li>Create snapshot of current root drive</li>\n<li>Mount it</li>\n<li>Make tar.gz that includes all content of mounted drive</li>\n<li>Copy that on my external hard drive</li>\n<li>Umounted and removed snapshot</li>\n</ol>\n\n<p>After that I've restarted my machine and did following:</p>\n\n<ol>\n<li>Create snapshot of current root drive</li>\n<li>Mount it</li>\n<li>Removed all content of that mounted dir</li>\n<li>Copied all data from external hdd (unpacked)</li>\n<li>Did merge</li>\n</ol>\n\n<p>And it was working, but now my sudo file is broken, and I guess there are other stuff that are broken also.</p>\n\n<p>I'm kind of a newbie for this kind of stuff so I anyone can help me with this. By using this or any other approach.</p>\n"},{"id":545008,"title":"Backup LVM snapshots and Grub2 problem","body":"<p>Long story short, I'm using <a href=\"http://obnam.org\">obnam</a> to take backups of my system.</p>\n\n<p>This is what I do:</p>\n\n<ol>\n<li>take LVM snapshot of <code>/</code>, <code>/usr</code>, <code>/boot</code>, <code>/var</code>, <code>/home</code></li>\n<li><p>mount the snapshots on <code>/bck-snapshots</code>, <code>/bck-snapshots/usr</code>, <code>/bck-snapshots/boot</code>, <code>/bck-snapshots/var</code>, <code>/bck-snapshots/home</code></p></li>\n<li><p>run the backup of snapshots:</p>\n\n<pre><code>obnam backup \\\n    /bck-snapshots \\\n    /bck-snapshots/usr  \\\n    /bck-snapshots/boot \\\n    /bck-snapshots/var  \\\n    /bck-snapshots/home \\\n</code></pre></li>\n<li><p>once the backup finishes, umount snapshot filesystems mounted in step 2.</p></li>\n<li><p>remove the snapshots</p></li>\n</ol>\n\n<p><strong>Problem</strong></p>\n\n<p>during the backup, a system update was done, with a new kernel installed and all the grub2 update dance. Now when I try to remove the root snapshot (step 5.) I get this:</p>\n\n<blockquote>\n  <p>device-mapper: remove ioctl on  failed: Device or resource busy</p>\n</blockquote>\n\n<p>because the snapshot root device is busy and used by another process:</p>\n\n<pre><code>$ sudo lsof /dev/dm-6 # This is the root snapshot device.\nlsof: WARNING: can't stat() fuse.gvfsd-fuse file system /run/user/1000/gvfs\n      Output information may be incomplete.\nCOMMAND    PID USER   FD   TYPE DEVICE   SIZE/OFF    NODE NAME\ngrub-moun 9160 root    3r   BLK  252,6 0t36339712 5295479 /dev/dm-6\n</code></pre>\n\n<p><strong>Questions</strong></p>\n\n<ol>\n<li><p>I guess that to lvremove the snapshot I have to stop <code>grub-mount</code> to use the device. How to do that safely?</p></li>\n<li><p>I think that the backup snapshot has been added to grub as a viable option to show in the grub menu shown at boot time. What if I remove the corresponding snapshot?</p></li>\n<li><p>Any way to prevent grub from adding the root snapshot found on /bck-snapshots ?</p></li>\n</ol>\n\n<p>I have to reboot the system in order for the updates to be active, but first I have to know the answer to these questions.</p>\n"},{"id":588530,"title":"Recover the directory structure of a lost LVM Logical volume?","body":"<p>I am aware of the huge amount of data recovery questions on this site, and reading all of them I think my case is unique enough to warrant a new question.</p>\n\n<h3>how it came to be</h3>\n\n<p>I set up a LVM with individual LV for each part of the system over two disks</p>\n\n<pre><code>$ lsblk\nNAME            MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT\nsda               8:0    0 931.5G  0 disk \n└─sda1            8:1    0 931.5G  0 part \n  └─datavg-data 254:4    0 543.8G  0 lvm  /data\nsdb               8:16   0 111.8G  0 disk \n├─sdb1            8:17   0   487M  0 part /boot/efi\n├─sdb2            8:18   0   244M  0 part /boot\n└─sdb3            8:19   0 111.1G  0 part \n  ├─notapc-root 254:0    0   5.5G  0 lvm  /\n  ├─notapc-usr  254:1    0   8.5G  0 lvm  /usr\n  ├─notapc-var  254:2    0   4.8G  0 lvm  /var\n  └─notapc-home 254:3    0  91.2G  0 lvm  /home\n</code></pre>\n\n<p>(I can give you the output of <code>lvdisplay</code> too, but I though it to long and unimportant</p>\n\n<p><code>apt</code>/<code>dpkg</code> started complaining about a lack of space on <code>/var</code>, <code>/</code> etc. so I decided to size them up. I also decided to decrease the size of my home partition, as most it was just symlinks (e.g. ~/Downloads to /data/username/Downloads/ anyway. So I just used lvreduce <em>&lt; whoops></em> <strong>before shrinking the filesystem</strong> <em>&lt; /whoops></em>.\nas expected, the filesystem could not be mounted on reboot. Since there was no important data I simply <code>dd if=/dev/mapper/notapc-home of=/data/brokenhome.bak</code> and made a new FS on the LV.</p>\n\n<p>I later discovered that I never symlinked my projects folder to <code>/data</code>, which means it never landed on a Backup (I only backup <code>/data</code>), which made me really glad I dd'd it.</p>\n\n<p>unfortunately I really struggled finding programs that could help me recover the partition. Testdisk would require my disk to still be intact, and I could not find more programs that can rebuild more than the partition table. <code>Strings</code> finds tons of stuff, which made me think maybe my project files could be recovered.</p>\n\n<p>How do I recover a LVM LV partition with 2G missing from the end from a file image of the partition?</p>\n"},{"id":552517,"title":"Restoring clonezilla image to newly created LVM partition","body":"<p>I have read an article about LVM and I would like to install it. Is it possible to make first an image of my total installation, then delete everything, create new LVM partitions as explained in the Wiki and after all that, restore the image to one of the newly created LVM partitions?</p>\n\n<p>I have ubuntu 14.04 64bit with all the latest updates and various development utils which would cost me days to reinstall freshly, especially as I am living in an exotic country with varying internet speeds, politely said.</p>\n\n<p>Thanks for an advice</p>\n"},{"id":554185,"title":"Restoring a VM to LV, GRUB disk not found","body":"<p>This is what my setup looks like:\nubuntu 14.04 running KVM with libvirt has a HW-Raid it's running from (/dev/sda) and another HW-RAID (/dev/sdb) that is the PV to a LVM VG called \"datavg\" with virtual machines installed into unformatted LVs.\nThen I backed up the VM like so:</p>\n\n<ul>\n<li>save libvirt/virsh config</li>\n<li>save the lv size</li>\n<li>save first 512Bytes (MBR &amp; GPT) using dd</li>\n<li>create a LVM snapshot of the LV</li>\n<li>map the partitions (using kpartx) and mount the root partition of the vm</li>\n<li>save fs type and uuid of that partition</li>\n<li>use duplicity to do incremental backup of everything (exclude /proc)</li>\n<li>unmount &amp; unmap</li>\n<li>remove snapshot</li>\n</ul>\n\n<p>This is what i ran on the \"way back\" to restore it to a vm called \"test-vm\" in a LV \"vm-test-lv\":</p>\n\n<ul>\n<li><p>create LV with the same size (from backup)</p>\n\n<p><code>lvcreate --name vm-test-lv --size 400.00G datavg</code></p></li>\n<li><p>dd the MBR &amp; GPT back into the first 512b at the beginning of the LV</p>\n\n<p><code>dd if=/data/backup/test/MBR-20141126T104236Z.raw of=/dev/datavg/vm-test-lv</code></p></li>\n<li><p>map the LV partitions</p>\n\n<p><code>kpartx -av /dev/datavg/vm-test-lv</code></p></li>\n<li><p>format it in the same FS with the same UUID (both from backup)</p>\n\n<p><code>mkfs.ext4 -U a5943cc4-6421-47a4-9613-30efd4dc44d4 /dev/mapper/datavg-vm--test--lv1</code></p></li>\n<li><p>mount the freshly formatted partition</p>\n\n<p><code>mount /dev/mapper/datavg-vm--test--lv1 /data/mnt/</code></p></li>\n<li><p>restore the duplicity backup</p>\n\n<p><code>duplicity restore --progress --restore-time 20141126T104236Z file:///data/backup/test /data/mnt</code></p></li>\n<li><p>unmount it</p>\n\n<p><code>umount /data/mnt</code></p></li>\n<li><p>remove the mapping</p>\n\n<p><code>kpartx -d /dev/mapper/datavg-vm--test--lv</code></p></li>\n<li><p>create the virtual machine (in this case with a different name and uuid because the original one still exists but is powered off)</p>\n\n<p><code>virsh create /data/backup/test/virsh-20141126T104236Z.xml</code></p></li>\n<li><p>try to boot</p></li>\n</ul>\n\n<p>That didn't work and it's hanging, looking at it through VNC via a SSH tunnel it's saying \"Booting from Hard Disk...\" (<a href=\"http://i.stack.imgur.com/LARcp.png\" rel=\"nofollow\">screenshot</a> since i'm not allowed to post inline images)</p>\n\n<p>I then tried to map it again, and chroot into it to try and do <code>grub-install</code> but that didn't work either: </p>\n\n<pre><code>root@kvm-host:~# mkdir /data/mnt/proc\nroot@kvm-host:~# mount --bind /proc /data/mnt/proc\nroot@kvm-host:~# mount --bind /dev /data/mnt/dev \nroot@kvm-host:~# mount --bind /sys /data/mnt/sys \nroot@kvm-host:~# chroot /data/mnt\nroot@kvm-host:/# grub-install /dev/mapper/datavg-vm--test--lv\nInstalling for i386-pc platform.\ngrub-install: error: disk `lvmid/eLefkO-MKtH-kOcq-pt0b-4zzO-31xg-XIqDpY/AcNuFk-JY2r-V8x5-gNoV-UCoi-uQug-8R0ZWZ' not found.\n</code></pre>\n\n<p>It is showing the correct UUIDs of the VG and the LV but i fear i'm using it wrong...\nCan anyone help me out?</p>\n"},{"id":431717,"title":"Format USB stick using LVM?","body":"<p>Is it possible to format a USB stick using LVM?  I am interested in LVM because apparently it allows you to create instantaneous snapshots for backup purposes.</p>\n"},{"id":26567,"title":"Using LVM snapshots on a live system: possibility of corruption due to system activity","body":"<p>If I am doing backups from LVM snapshots of a live system, how can I best avoid problems due to the snapshot being taken during things like upgrades?  Presumably this wouldn't be catastrophic, since it would be less serious than a power outage during the upgrade, but it could cause at least some amount of inconvenience.</p>\n"}]}]