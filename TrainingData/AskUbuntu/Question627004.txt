[{"id":627004,"title":"In 14.04 Packages/reboot warnings in motd take an additional login to show up","body":"<p>Note: This is not a new problem and has been going on for a while.</p>\n\n<p>If you log in via SSH when new updates are available or after installing updates, the MOTD doesn't reflect the last changes you've done... unless you log out and then back in again.</p>\n\n<p>I logged in this morning as a user that doesn't have <code>sudo</code> access this morning and saw this in the MOTD:</p>\n\n<pre><code>8 packages can be updated.\n6 updates are security updates.\n</code></pre>\n\n<p>So, I opened a second SSH session and logged in as my user that does have <code>sudo</code> access and saw this in the MOTD:</p>\n\n<pre><code>16 packages can be updated.\n14 updates are security updates.\n</code></pre>\n\n<p>I installed these updates, and <em>specifically to test this</em> logged my non-sudo user out and back in on a separate terminal, which displayed this in the MOTD</p>\n\n<pre><code>16 packages can be updated.\n14 updates are security updates.\n</code></pre>\n\n<p>I logged that user out and back in again and saw this in the MOTD:</p>\n\n<pre><code>0 packages can be updated.\n0 updates are security updates.\n\n*** System restart required ***\n</code></pre>\n\n<p>Is there some caching going on or some setting I need to disable to get this to be correctly up to date?</p>\n","related_questions":[{"id":538732,"title":"No MOTD on Ubuntu 14.04...?","body":"<p>I recently did a fresh install of Ubuntu 14.04. When I SSH, there is no MOTD (and yes, I have the appropriate command set in sshd_config).</p>\n\n<p>I read a bunch of tutorials about setting up MOTD, but I realized that while I have /etc/update-motd.d, there is not /etc/motd file nor a /var/run/motd file.</p>\n\n<p>How can I set these up so that I can get a MOTD via SSH?</p>\n"},{"id":537521,"title":"Set user- or group-specific MOTD in SSH","body":"<p>I would like to disable or change the MOTD shown on SSH login on a per-group/per-user basis. <a href=\"http://superuser.com/questions/704590/can-i-disable-ssh-last-login-and-motd-on-a-per-user-basis\">This question on SuperUser</a> has an answer stating that I can use <code>Match</code> blocks in <code>sshd_config</code>. However, <code>man sshd_config</code> states:</p>\n\n<pre><code>Match\n         ...\n         Only a subset of keywords may be used on the lines following a\n         Match keyword.  Available keywords are AcceptEnv,\n         AllowAgentForwarding, AllowGroups, AllowTcpForwarding,\n         AllowUsers, AuthenticationMethods, AuthorizedKeysCommand,\n         AuthorizedKeysCommandUser, AuthorizedKeysFile,\n         AuthorizedPrincipalsFile, Banner, ChrootDirectory, DenyGroups,\n         DenyUsers, ForceCommand, GatewayPorts, GSSAPIAuthentication,\n         HostbasedAuthentication, HostbasedUsesNameFromPacketOnly,\n         KbdInteractiveAuthentication, KerberosAuthentication,\n         MaxAuthTries, MaxSessions, PasswordAuthentication,\n         PermitEmptyPasswords, PermitOpen, PermitRootLogin, PermitTTY,\n         PermitTunnel, PubkeyAuthentication, RekeyLimit,\n         RhostsRSAAuthentication, RSAAuthentication, X11DisplayOffset,\n         X11Forwarding and X11UseLocalHost.\n</code></pre>\n\n<p>And I can't see anything related to MOTD in that list. And indeed, trying to use that suggestion causes <code>sshd</code> to fail to start because of incorrect configuration. </p>\n\n<p>So, can I do this? If so, how? From the SSH configuration or by altering whatever generates/prints the MOTD?</p>\n\n<hr>\n\n<p>Altering files in <code>/etc/update-motd.d</code> isn't useful, since, according to <a href=\"http://manpages.ubuntu.com/update-motd\" rel=\"nofollow\"><code>man update-motd</code></a>:</p>\n\n<pre><code>   Executable  scripts in /etc/update-motd.d/* are executed by pam_motd(8)\n   as the root user at each login, and this information is concatenated in\n   /var/run/motd. \n</code></pre>\n\n<p>(I tested this out with a script that did <code>echo $USER</code>. I got a <code>root</code> in my MOTD.)</p>\n\n<p>That leaves PAM configuration. I imagine it might be possible to disable <code>pam_motd</code> on a per-group/user basis, but I am not sure how to do it. The last option would be to disable <code>pam_motd</code> altogether, and use <code>pam_exec</code>, but I really hope it doesn't come to that.</p>\n"},{"id":541270,"title":"Custom MOTD does not update until scripts finish","body":"<p>I recently got a small server and gave some friends accounts on it.  They all have their own web pages in <code>~/public_html</code> using <code>lighttpd</code> so I wrote a script to backup every user's <code>public_html</code> directory.  I have the script in my <code>.profile</code> so it executes every time I log in and then back up the data to my laptop.  When the script starts it writes \"PROCESSING\" to a log file.</p>\n\n<p>I also have a custom bash script in <code>/etc/update-motd.d/</code> that runs a python script to display when the most recent backup was completed in the MOTD for every user.  If the log file says \"PROCESSING\", however, it should display that instead of the time past since last backup.  However, this is not what actually happens.  If I ssh in from one terminal and my backup script starts, then ssh in from a second terminal, the MOTD still displays the time since last backup.  A <code>cat</code> from the command line in the second shell shows that the log file does indeed contain \"PROCESSING\".</p>\n\n<p>I then added a timestamp to my last backup script so that the current time is displayed in the MOTD.  This led me to discover that the MOTD is not updated while my backup script is running.  As soon as my backup script finishes running the timestamp in the MOTD is updated again.</p>\n\n<p>So my question is why would the MOTD fail to update in a second ssh session until a script from my <code>.profile</code> finishes running in the first session?</p>\n"},{"id":540775,"title":"MOTD - show memory usage, 50-landscape-sysinfo without swap info","body":"<p>I would like to display the MOTD without swap info, because my machine does not have swap. </p>\n\n<p>I have found the link <code>ls /etc/update-motd.d/50-landscape-sysinfo</code> which points to the file <code>/usr/bin/landscape-sysinfo</code> which displays the following message:</p>\n\n<pre><code>System load:  7.5               Processes:           434\nUsage of /:   84.2% of 9.72GB   Users logged in:     1\nMemory usage: 5%                IP address for eth0: 10.9.8.161\nSwap usage:   0%\n\nGraph this data and manage this system at:\n  https://landscape.canonical.com/\n</code></pre>\n\n<p>I have added the contents of both <code>ls /etc/update-motd.d/50-landscape-sysinfo</code> and <code>/usr/bin/landscape-sysinfo</code> <a href=\"http://pastebin.com/rdYqD2he#\" rel=\"nofollow\">here on pastebin</a>. I would like to remove <code>Swap usage:     0%</code> from this message, as it could cause confusion. I don't know what is the best way to go about doing this, any suggestions?</p>\n"},{"id":520296,"title":"Ubuntu 12.04: pam_motd sometimes displays only partial MOTD","body":"<p>This isn't a very big deal but it really irritates me somehow.</p>\n\n<p>We have a large number of machines running Ubuntu 12.04 (server/amd64) which i frequently ssh into. We have the standard set-up for this version of Ubuntu, where there are a handful of scripts in <code>/etc/update-motd.d</code> that are used to build the MOTD, and <code>/etc/pam.d/sshd</code> is configured to print the MOTD on ssh log-in via <code>pam_motd.so</code>. Our MOTD scripts are all custom (we don't have any of the built-in Ubuntu ones on these machines), but everything else is absolutely stock Ubuntu server config. For the most part, this works fine.</p>\n\n<p>However, once in a while, the MOTD is displayed only partially (or sometimes not at all). There is no error message either at the terminal or in any logs that i can find, it just doesn't display the complete output. If i <code>cat /var/run/motd</code> immediately after this occurs, that file <em>does</em> show the full (and up-to-date) output, though.</p>\n\n<p>I know that <code>run-parts</code> has an option to stop processing scripts if one of them exits with a >0 status, but i don't think that's applicable in this case — often the output is truncated <em>in the middle</em> of the script execution. For example, one script might print out some lines like this:</p>\n\n<pre><code>mycompany header\n\nhostname uname\ncpu\nram\nuptime\n</code></pre>\n\n<p>But the MOTD will stop immediately after <code>mycompany header</code>. These are very simple bash scripts and we do not have the <code>-e</code> option enabled in them, so i don't know how this can even happen. At first i thought that maybe there was a limit on the amount of time that PAM would wait for the MOTD to be generated, and that maybe sometimes (depending on load or whatever) we might be hitting that limit — but that doesn't seem to be the case. The MOTD is printed almost immediately every time, whether it's truncated or not.</p>\n\n<p>The only other thing i can think of is that maybe <code>run-parts</code> is writing the dynamic MOTD file out one line at a time, and there is some kind of race condition where <code>pam_motd</code> is reading an incomplete version of that file.</p>\n\n<p>However, i can't confirm that, because i have no idea what the mechanism is behind this functionality. My understanding is that PAM somehow fires off <code>run-parts</code> to update the file on log-in, but i can't find any references to <code>run-parts</code> or <code>/etc/update-motd.d</code> in the <a href=\"http://packages.ubuntu.com/source/precise/pam\" rel=\"nofollow\">PAM source</a>. All the <code>pam_motd</code> code seems to do is just read in the MOTD file.</p>\n\n<p>The only possibly useful clue i could find is this: If i do <code>watch -n 0.1 'ps aux | grep \"run-parts\"'</code> in one terminal window, as i disconnect and re-connect to the same host in another window, i can see that, when the output is complete, there are always several processes that appear very briefly in the process list — but when it's truncated, there are only one or two processes (sometimes none at all).</p>\n\n<p>edit: I should also add that i can't replicate this problem at all when i execute <code>run-parts --lsbsysinit /etc/update-motd.d</code> manually; it <em>only</em> seems to happen at ssh log-in.</p>\n\n<p>How can i troubleshoot this further? How does PAM instruct the system to update the MOTD? Does it wait for that process to finish, or does it run concurrently? Is there a way to change that behaviour? Is there a debug option i can set somewhere to at least see what's happening? Is there any expected reason that <code>run-parts</code> might abort in the middle of a script?</p>\n\n<p>cheers</p>\n"},{"id":518959,"title":"MOTD displaying content of /etc/motd generated at boot / previous login","body":"<p>I have an Ubuntu server running at sandbox.plushu.org - if you add your key at <a href=\"http://enter.sandbox.plushu.org\" rel=\"nofollow\">http://enter.sandbox.plushu.org</a>, you can connect to the server as root@sandbox.plushu.org. You can reset the server by pressing the reset button on <a href=\"http://reset-sandbox.plushu.org\" rel=\"nofollow\">http://reset-sandbox.plushu.org</a>.</p>\n\n<p>I have a custom time-sensitive MOTD on this server. The problem that I'm seeing is that this MOTD, when regenerated (via /etc/update-motd/*) at login, is not <em>displayed</em> until the <em>next</em> login. The first time you log in, you will see the MOTD as generated at boot: the next time you log in, you will see the MOTD as generated the <em>last</em> time you logged in.</p>\n\n<p>What is causing this behavior? How can it be fixed so that, on logging in, the MOTD is generated, <em>then</em> displayed?</p>\n"},{"id":401659,"title":"No MOTD on first login after upgrade to 13.10","body":"<p>One of my favorite things when I installed Ubuntu Server 10.04LTS was the MOTD with the landscape-common data.  After updating to 13.10 and having some trouble at first with MOTD not working at all, it finally does work, but not during the first login.  Once I exit and log back in, then the MOTD does show.</p>\n"},{"id":382931,"title":"How to remove legal notice from MOTD / Banner for non-root users","body":"<h1>Problem:</h1>\n\n<p>The following text is shown for all <strong>non-root</strong> users when logging in via SSH:</p>\n\n<blockquote>\n  <p>The programs included with the Ubuntu system are free software;<br>\n  the exact distribution terms for each program are described in the<br>\n  individual files in /usr/share/doc/*/copyright.</p>\n  \n  <p>Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by<br>\n  applicable law.</p>\n</blockquote>\n\n<hr>\n\n<h1>Configuration:</h1>\n\n<ul>\n<li>My <code>/etc/ssh/sshd_config</code> includes:</li>\n</ul>\n\n<blockquote>\n  <p>PrintMotd no<br>\n  PrintLastLog no                                                       </p>\n</blockquote>\n\n<ul>\n<li><code>PrintMotd no</code> and <code>PrintLastLog no</code> are overriden by PAM in <code>/etc/pam.d/sshd</code></li>\n</ul>\n\n<blockquote>\n  <p>session    optional     pam_motd.so </p>\n  \n  <p>session     optional     pam_lastlog.so   never showfailed</p>\n</blockquote>\n\n<ul>\n<li><code>/var/run/motd</code> is symlinked to <code>/etc/motd</code> :</li>\n</ul>\n\n<blockquote>\n  <p>/etc/motd -> /var/run/motd</p>\n</blockquote>\n\n<ul>\n<li>The folder <strong>/etc/update-motd.d/</strong> is empty !</li>\n</ul>\n\n<hr>\n\n<h1>Question:</h1>\n\n<p>How can i disable the display of the above notice for non-root users?</p>\n"},{"id":163184,"title":"Persistent &quot;disk will be checked...&quot; in the message of the day (motd) even after reboot","body":"<p>I see that there are some other threads that mention this error, but I have tried the solutions with no luck.</p>\n\n<p>When I log into my 12.04 Server, I get the message:</p>\n\n<pre><code>/dev/sdb1 will be checked for errors at next reboot\n/dev/sdc1 will be checked for errors at next reboot\n</code></pre>\n\n<p>The problem is that the check is never done and I continue to get the messages.  I ran a fsck on both drives and they are fine.</p>\n"},{"id":301907,"title":"Why does MOTD and &quot;landscape-sysinfo&quot; show different disk usage to &quot;df&quot;?","body":"<p>I have several drives on my server mounted separately. They are getting close to full. When I <code>ssh</code> to my server, <code>motd</code> reports disk usage, for example:</p>\n\n<pre><code>=&gt; /home is using 89.3% of 916.89GB\n</code></pre>\n\n<p>But if I run <code>df -h</code>, it reports:</p>\n\n<pre><code>/dev/sdd1       917G  826G   45G  95% /home\n</code></pre>\n\n<p>This happens for all my drives; <code>motd</code> consistently reports lower numbers. It looks likes <code>motd</code> runs <code>landscape-sysinfo</code> to report this information.</p>\n\n<p>Why are they different and which is correct?</p>\n"}]}]